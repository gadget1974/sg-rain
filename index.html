<!doctype html><meta charset="utf-8">
<title>SG Rain 50km (clean)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html,body{margin:0;background:#f4f4f4}
  #wrap{display:flex;justify-content:center;align-items:center;min-height:100vh}
  #map{position:relative;width:853px;height:479px;box-shadow:0 4px 20px rgba(0,0,0,0.12);background:#e6e6e6}
  #map img{position:absolute;inset:0;width:853px;height:479px;image-rendering:auto}
  #ts{position:absolute;bottom:8px;right:8px;font:14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:#fff9;padding:2px 6px;border-radius:4px}
  #badge{position:absolute;top:8px;left:8px;font:12px system-ui;background:#fff9;padding:2px 6px;border-radius:4px}
</style>
<div id="wrap">
  <div id="map">
    <img id="base" src="https://www.nea.gov.sg/assets/images/map/base-853.png" alt="Base map">
    <img id="overlay" alt="Rain overlay">
    <div id="badge">Weather.gov.sg â€“ Rain area 50km</div>
    <div id="ts"></div>
  </div>
</div>
<script>
  const z = n => String(n).padStart(2,'0');
  const build = (d) => {
    const y=d.getFullYear(), m=z(d.getMonth()+1), day=z(d.getDate());
    const hh=z(d.getHours()), mm=z(d.getMinutes());
    return `https://www.weather.gov.sg/files/rainarea/50km/v2/dpsri_70km_${y}${m}${day}${hh}${mm}0000dBR.dpsri.png`;
  };
  function floorTo5Min(d){
    const copy = new Date(d);
    copy.setMinutes(copy.getMinutes() - (copy.getMinutes()%5), 0, 0);
    return copy;
  }
  function formatSG(d){
    const y=d.getFullYear(), m=z(d.getMonth()+1), day=z(d.getDate());
    const hh=z(d.getHours()), mm=z(d.getMinutes());
    return `${y}-${m}-${day} ${hh}:${mm} SGT`;
  }
  function update(){
    const nowSG = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Singapore'}));
    let slot = floorTo5Min(nowSG);
    const overlay = document.getElementById('overlay');
    const ts = document.getElementById('ts');
    let attempts = 0;
    function tryLoad(){
      overlay.src = build(slot) + `#${Date.now()}`; // cache-bust
      overlay.onload = () => { ts.textContent = formatSG(slot); };
      overlay.onerror = () => {
        if (attempts < 6) { // step back up to 30 minutes if needed
          attempts++;
          slot = new Date(slot.getTime() - 5*60*1000);
          tryLoad();
        } else {
          ts.textContent = "No recent image available";
        }
      };
    }
    tryLoad();
  }
  update();
  setInterval(update, 300000); // refresh every 5 minutes
</script>
