<!doctype html><meta charset="utf-8">
<title>SG Rain 50 km snapshot</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
  :root{--w:853px;--h:479px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  html,body{margin:0;background:#f4f4f4}
  #wrap{display:flex;flex-direction:column;align-items:center;gap:.5rem;min-height:100vh;justify-content:center}
  #time{font-size:1rem;font-weight:500;color:#333}
  #map{position:relative;width:var(--w);height:var(--h);box-shadow:0 4px 20px rgba(0,0,0,.12);background:#e6e6e6}
  #map img{position:absolute;inset:0;width:var(--w);height:var(--h);image-rendering:auto}
  #badge{position:absolute;top:8px;left:8px;background:#fff9;padding:2px 6px;border-radius:4px;font-size:.75rem}
  #ts{position:absolute;bottom:8px;right:8px;background:#fff9;padding:2px 6px;border-radius:4px;font-size:.8rem}
  #rotate{position:absolute;bottom:8px;left:8px;background:#fff9;padding:2px 6px;border-radius:4px;font-size:.8rem;font-style:italic}
  #wiggle{width:100%;background:#f4f4f4;} /* height is set dynamically to 0‑3 px */
</style>
<div id="wrap">
  <div id="time">TIME PLACEHOLDER</div>
  <div id="map">
    <img id="base" src="https://www.nea.gov.sg/assets/images/map/base-853.png" alt="Base map">
    <img id="overlay" alt="Rain overlay">
    <div id="badge">Weather.gov.sg – Rain area&nbsp;50 km</div>
    <div id="rotate"></div>
    <div id="ts"></div>
  </div>
  <div id="wiggle"></div>
</div>
<script>
  const z = n => String(n).padStart(2,'0');
  const phrases = ["Weather Report","Weather Update","Rainfall Chart","Rainfall Map","SG Rain Map"];
  function floorTo5(d){ const c=new Date(d); c.setMinutes(c.getMinutes()-c.getMinutes()%5,0,0); return c; }
  function fmt(d){ return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0') + ' SGT'; }
  function overlayURL(d){
      const y=d.getFullYear(), m=z(d.getMonth()+1), day=z(d.getDate());
      const hh=z(d.getHours()), mm=z(d.getMinutes());
      return `https://www.weather.gov.sg/files/rainarea/50km/v2/dpsri_70km_${y}${m}${day}${hh}${mm}0000dBR.dpsri.png`;
  }
  function pickPhrase(idx){ return phrases[idx%phrases.length]; }
  function nowSG(){ return new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Singapore'})); }
  function update(){
      const now = nowSG();
      let slot = floorTo5(new Date(now));
      document.getElementById('time').textContent = "Last refresh: " + fmt(now);
      document.getElementById('rotate').textContent = pickPhrase(Math.floor(slot.getMinutes()/5));
      
      /* --- DYNAMIC WIGGLE: height cycles 1‑3 px to guarantee bitmap diff --- */
      const wiggle = document.getElementById('wiggle');
      wiggle.style.height = ((slot.getMinutes()/5)%3 + 1)+"px";
      
      /* Load radar overlay with fallback of 1h */
      const overlay = document.getElementById('overlay');
      let retries = 0;
      function load(){
        overlay.src = overlayURL(slot)+"?v="+Date.now();
      }
      overlay.onload = ()=>{ document.getElementById('ts').textContent = fmt(slot); };
      overlay.onerror = ()=>{
        if(++retries < 12){ slot = new Date(slot.getTime() - 5*60000); load(); }
        else{ document.getElementById('ts').textContent = "No recent image"; }
      };
      load();
  }
  update();
  setInterval(update, 300000);
</script>
